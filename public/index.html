<!DOCTYPE html>
<html ng-app="piclleryApp">
  <head>
    <title>Picllery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css' />
    <link href='http://fonts.googleapis.com/css?family=Poiret+One|Limelight|Abril+Fatface' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="/javascripts/ng-file-upload-all.min.js"></script>
    <script src="/javascripts/ui-bootstrap-tpls-0.13.0.min.js"></script>
    <script src="/javascripts/main.js"></script>
  </head>
  <body>
    <div ng-controller="mainController">
      <header>
        <h1 id="title" ng-click="renderHome()"><span id="one">Pic</span><span id="two">lle</span><span id="three">ry</span></h1>
        <nav>
          <div id="not-logged-in" ng-if="logged_in.username == null">
            <div id="links">
              <h1 class="link" id="login" ng-click="renderLogin()">Login</h1>
              <h1 class="link" id="create-prof" ng-click="renderCreateProfile()">Create Profile</h1>
            </div>
          </div>
          <div id="logged-in" ng-if="!(logged_in.username == null)">
            <div id="status">
              <p>Logged in as <strong>{{ logged_in.username }}</strong>.</p>
              <p id="logout" ng-click="logout(logged_in.username)"><strong>Logout</strong></p>
            </div>
            <div id="links">
              <h1 class="link" id="view-prof" ng-click="viewProfile(logged_in.username)">View Profile</h1>
              <h1 class="link" id="upload" ng-click="renderUploadForm()">Upload Picture</h1>
            </div>
          </div>
        </nav>
      </header>

      <!-- HOME PAGE -->
      <div class="container-fluid home page">
        <div class="row">
          <aside class="section col-xs-12 col-sm-12 col-md-2 col-lg-2 pull-right no-padding">
            <h2 id="user-title">USERS</h2>
            <nav class="users">
              <h1 class="user" ng-repeat="user in users.usernames" ng-click="viewProfile(user.username)">{{ user.username }}</h1>
            </nav>
          </aside>
          <div class="container-fluid">
            <div id="map-all" class="section purple col-xs-12 col-sm-12 col-md-5 col-lg-5">
              <div class="inner-container">
                <div id="map-canvas"></div>
              </div>
            </div>
            <div id="recent-pop-pics" class="section purple col-xs-12 col-sm-12 col-md-5 col-md-offset-5 col-lg-5 col-lg-offset-5">
              <div class="inner-container">
                <div>
                  <span><h2>RECENT</h2></span>
                  <div>
                    <div ng-click="setMarker(pic.location, map)" ng-repeat="pic in users.recent" class="pic">
                      <img src="{{ pic.picture }}" ng-click="showLikesAndLink(pic.id)">
                      <div ng-if="thumb_clicked == pic.id" class="thumb-click" ng-click="viewProfileWithPic(pic.picture, pic.location, pic.address, pic.private, pic.likes, pic.id, pic.username)"><p>Click here to view</p></div>
                    </div>
                  </div>
                </div>
                <div>
                  <span><h2>POPULAR</h2></span>
                  <div>
                    <div ng-click="setMarker(pic.location, map)" ng-repeat="pic in users.popular" class="pic">
                      <img src="{{ pic.picture }}" ng-click="showLikesAndLink(pic.id)">
                      <div ng-if="thumb_clicked == pic.id" id="pop-likes" class="thumb-click"><p>
                        <span>{{ pic.likes }} </span>Like<span ng-if="pic.likes == 0 || pic.likes > 1">s</span>
                      </p></div>
                      <div ng-if="thumb_clicked == pic.id" class="thumb-click" ng-click="viewProfileWithPic(pic.picture, pic.location, pic.address, pic.private, pic.likes, pic.id, pic.username)"><p>Click here to view</p></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <nav class="mobile">
          <ul>
            <ul id="mobile-nav">
              <li id="recent-link">Pics</li>
              <li id="map-link">Map</li>
              <li id="users-link">Users</li>
            </ul>
            <li>NAV</li>
          </ul>
        </nav>
      </div>

      <!-- PROFILE PAGE -->
      <div class="container-fluid profile page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="profile">
              <div id="profile-pic"><img src="{{ profile.prof_pic }}" alt="{{ profile.username }}'s profile pic"></div>
              <div id="full-name"><h1>{{ profile.first_name }} {{ profile.last_name }}</h1></div>
              <div class="details">
                <h2><span>Username:</span> {{ profile.username }}</h2>
                <h2><span>Email:</span> {{ profile.email }}</h2>
                <h2><span>Bio:</span><div>{{ profile.bio }}</div></h2>
              </div>
              <div class="prof-options" ng-if="logged_in.username == profile.username">
                <p id="edit" ng-click="renderEditProfile()">Edit</p>
                <p id="delete" ng-click="delete.prof.clicked = true">Delete</p>
              </div>
            </div>
            <div class="gallery col-xs-12 col-sm-12 col-md-12 col-lg-12 row no-padding">
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 no-padding" >
                <div id="gallery"> <!-- GALLERY -->
                  <div id="gallery-legend" ng-if="logged_in.username == profile.username">
                    <h2><a href="#all-pics">All</a></h2><h2><a href="#pub-pics">Public</a></h2><h2><a href="#priv-pics">Private</a></h2>
                  </div>
                  <div class="no-pics" ng-if="user_pics == null"><span>User has no pics.</span></div>
                  <div id="all-pics-container">
                    <div class="pics-container" id="all-pics" ng-if="!(user_pics == null)">
                      <div class="pic" ng-repeat="pic in user_pics" ng-click="displayPic(pic.picture, pic.location, pic.address, pic.private, pic.likes, pic.id, pic.username)"><a href="#picture"><img src="{{ pic.picture }}"></a></div>
                    </div>
                    <div id="pub-priv-container" ng-if="logged_in.username == profile.username">
                      <div class="pics-container" id="pub-pics" ng-if="!(user_pics == null)">
                        <div class="pic" ng-repeat="pic in user_pics | filter: {private: 'f'}" ng-click="displayPic(pic.picture, pic.location, pic.address, pic.private, pic.likes, pic.id, pic.username)"><a href="#picture"><img src="{{ pic.picture }}"></a></div>
                      </div>
                      <div class="pics-container" id="priv-pics" ng-if="!(user_pics == null)">
                        <div class="pic" ng-repeat="pic in user_pics | filter: {private: 't'}" ng-click="displayPic(pic.picture, pic.location, pic.address, pic.private, pic.likes, pic.id, pic.username)"><a href="#picture"><img src="{{ pic.picture }}"></a></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 no-padding">
                <div id="picture">
                  <div>Click an image in the gallery.</div>
                  <img ng-click="togglePicOptions()"> <!-- PICTURE -->
                  <div id="edit-pic-button" ng-if="current_pic.user == logged_in.username && logged_in.username !== null" ng-click="renderEditPic()">Edit</div>
                  <div id="delete-pic-button" ng-if="current_pic.user == logged_in.username && logged_in.username !== null" ng-click="delete.pic.clicked = true">Delete</div>
                  <div id="likes">
                    <span id="count"></span> Likes. <button ng-click="addLikes(current_pic.id, current_pic.likes, current_pic.user)">Click here to like.</button>
                  </div>
                  <div id="toggle-hint"><p>Click Pic to Toggle</p></div>
                  <div id="expand" ng-click="expandPic(current_pic.picture)"><p>Expand</p></div>
                </div>
              </div>
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4 no-padding">
                <div><!-- MAP -->
                  <div id="map-canvas-user" class="google-maps"></div>
                </div>
              </div>
            </div>
          </div>
          <div ng-if="src" class="col-xs-12 col-sm-12 col-md-12 col-lg-12 expand-container no-padding">
            <img id="expanded-pic" src="{{ src }}">
            <span id="close-expand" ng-click="closeExpand()"><p>Close</p></span>
          </div>
          <nav class="profile-mobile">
            <a href="#gallery">Gallery</a>
            <a href="#picture">Picture</a>
            <a href="#map-canvas-user">Location</a>
          </nav>
        </div>
      </div>

      <!-- LOGIN PAGE -->
      <div class="container-fluid login page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <form id="login-form">
              <div class="form-group">
                <h2 class="error" id="username-error">INVALID USERNAME. Please try again.</h1>
                <label for="username">Username:</label><input class="form-control" id="username" name="username" type="text" autocomplete required><br>
                <h2 class="error" id="password-error">INVALID PASSWORD. Please try again.</h1>
                <label for="password">Password:</label><input class="form-control" id="password" name="password" type="password" autocomplete required><br>
                <button type="submit" ng-click="submitLogin()">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- CREATE/UPDATE PROFILE PAGE -->
      <div class="container-fluid create-prof update-prof page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <form id="create-prof-form">
              <div class="form-group">
                <span class="error" id="username-taken">Username is taken, please try again! Usernames are case-insensitive.<br></span>
                <label for="username">Username:</label><input class="form-control" value="{{ profile.username }}" id="new-username" name="username" size="30" type="text" placeholder="Enter Username" required><br>
                <label for="password">Password:</label><input class="form-control" id="new-password" name="password" type="password" placeholder="Enter New Password" required><br>
                <span class="error" id="pass-mismatch">Passwords do not match, please try again!<br></span>
                <label for="re-password">Password, Again:</label><input class="form-control" id="re-password" name="re-password" type="password" placeholder="Re-enter Password" required><br>
                <div class="row">
                  <div class="col-lg-6 no-padding"><label for="first-name">First Name:</label><input class="form-control" value="{{ profile.first_name }}" id="first-name" name="first-name" type="text" autocomplete required></div>
                  <div class="col-lg-6 no-padding"><label for="last-name">Last Name:</label><input class="form-control" value="{{ profile.last_name }}" id="last-name" name="last-name" type="text" autocomplete required></div>
                </div><br>
                <span class="error" id="email-taken">Email is already registered, please try again! Emails are case-insensitive.<br></span>
                <label for="email">Email:</label><input class="form-control" value="{{ profile.email }}" id="email" name="email" type="email" placeholder="e.g. hello_there@gmail.com" autocomplete required><br>
                <label for="prof-pic">Profile Picture:</label>
                <span><p>Min size: 10KB, Max Size: 5MB. Keep file name short, please.</p></span>
                <input class="form-control" ng-model="file.picFile" name="file" type="file" ngf-select ngf-capture="'camera'" accept="'image/*'" ngf-min-size='10000' ngf-max-size='5000000'><br>
                <span class="preview-legend">Preview:</span><br><img ngf-src="file.picFile[0]" ngf-default-src="/images/preview.png" ngf-accept="'image/*'" ngf-min-size='10000' ngf-max-size='5000000' class="preview"><br><br>
                <label for="bio">Bio:</label><textarea class="form-control" value="{{ profile.bio }}" id="bio" name="bio" rows="4" placeholder="Tell us a little about yourself..."></textarea><br>
                <button id="submit-prof" type="submit" ng-click="submitProfile(file.picFile)">Submit</button>
                <button id="edit-prof" type="submit" ng-click="editProfile(file.picFile, logged_in.username, 'logged_in')">Submit</button>
                <span ng-if="progress"><p>UPLOADING IN PROGRESS... {{ progress }}</p></span>
                <span class="cur-p" ng-click="showUnfreshProfile()"><p>Cancel</p></span>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- UPLOAD/EDIT PICTURE PAGE -->
      <div class="container-fluid upload update-pic page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <form id="upload-form">
              <div class="form-group">
                <div ng-if="isUpload.upload">
                  <label for="picture">Picture:</label>
                  <span><p>Min size: 10KB, Max Size: 5MB. Keep file name short, please.</p></span>
                  <input class="form-control" ng-model="file.picFile" required name="file" type="file" ngf-select ngf-capture="'camera'" accept="'image/*'" ngf-min-size='10000' ngf-max-size='5000000'><br>
                  <span class="preview-legend">Preview:</span><br>
                  <img ngf-src="file.picFile[0]" ngf-default-src="/images/preview.png" ngf-accept="'image/*'" ngf-min-size='10000' ngf-max-size='5000000' class="preview"><br><br>
                </div>
                <label for="location">Location (address):</label>
                <input ng-if="isUpload.upload" class="form-control" id="location" name="location" type="text" required>
                <input ng-if="!isUpload.upload" class="form-control" id="location" name="location" type="text" value="{{ reverse_geocode_location }}" required><br>
                <button type="button" ng-if="isUpload.upload" class="btn btn-primary" ng-model="checkbox.private" btn-checkbox btn-checkbox-true="'t'" btn-checkbox-false="'f'">
                  Private: {{ checkbox.private }}
                </button>
                <button type="button" ng-if="!isUpload.upload" class="btn btn-primary" ng-model="checkbox.private" btn-checkbox btn-checkbox-true="'t'" btn-checkbox-false="'f'" value="{{ current_pic.private }}">
                  Private: {{ checkbox.private }}
                </button><br>
                <button ng-if="isUpload.upload" type="submit" value="encode" ng-click="uploadPic(file.picFile,logged_in.username)">Submit</button>
                <button ng-if="!isUpload.upload" type="submit" value="encode" ng-click="updatePic()">Submit</button>
                <span ng-if="progress && isUpload.upload"><p>UPLOADING IN PROGRESS... {{ progress }}</p></span>
                <span ng-if="!isUpload.upload" class="cur-p" ng-click="showUnfreshProfile()"><p>Cancel</p></span>
                <span ng-if="isUpload.upload" class="cur-p" ng-click="cancelUpload()"><p>Cancel</p></span>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div ng-if="delete.prof.clicked || delete.pic.clicked" id="sure"><p>Are you sure you want to delete?</p><br><button ng-if="delete.pic.clicked" ng-click="deletePic()">Yes</button><button ng-if="delete.prof.clicked" ng-click="deleteProfile(logged_in.username)">Yes</button><button ng-click="resetDelete()">No, Cancel.</button></div>
    </div>

    <div id="footer">
      <p><small>Copyright &#169; 2015 Picllery. All rights reserved.</small></p>
    </div>
    <script>
      var piclleryApp = angular.module("piclleryApp", ['ngFileUpload','ui.bootstrap'])
      .controller("mainController", ['$scope', '$http', 'Upload', function($scope, $http, Upload) {

        $scope.logged_in = {username: null};
        $scope.resetDelete = function () {
          $scope.delete = {
            prof: {clicked: false},
            pic: {clicked: false}
          };
        };
        $scope.resetDelete();

        $scope.hideAllPgs = function() {
          // A reset, of sorts
          $(".page").hide();
          $("#picture img").hide();
          $(".error").hide();
          $("#likes, #edit-pic-button, #delete-pic-button, #toggle-hint, #expand").css("display","none");
          $("#new-username, #email").prop("disabled", false);
          $scope.thumb_clicked = false;
          $scope.delete.clicked = false;
        };

        $scope.renderHome = function() {
          $scope.hideAllPgs();
          $(".home").show();
          $scope.getHome();
        };

        $scope.getHome = function() {
          // when landing on the page, get all usernames and show them
          $http.get('/api/home')
            .success(function(data) {
              $scope.users = {
                usernames: data.usernames,
                recent: data.recent,
                popular: data.popular
              };
              var latlng = new google.maps.LatLng(1.0000, 1.0000); // Center of world map
              var mapOptions = {
                zoom: 1,
                center: latlng
              };
              $scope.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
              var marker = {
                recent: [],
                popular: []
              };
              for (var i=0; i < $scope.users.recent.length; i++) {
                $scope.getCoords($scope.users.recent[i].location);
                marker.recent[i] = new google.maps.Marker({
                  map: $scope.map,
                  position: $scope.myLatLng
                });
              }
              for (var i=0; i < $scope.users.popular.length; i++) {
                $scope.getCoords($scope.users.popular[i].location);
                marker.popular[i] = new google.maps.Marker({
                  map: $scope.map,
                  position: $scope.myLatLng
                });
              }
              $scope.logged_in.username = data.logged_in_as;
              console.log(data);
            })
            .error(function(data) {
              console.log('Error: ' + data);
            });
        };

        $scope.renderHome();

        $scope.renderLogin = function() {
          $scope.hideAllPgs();
          $(".login").show();
        };

        $scope.submitLogin = function() {
          var login_data = {
            username: $("#username").val(),
            password: $("#password").val()
          };
          $http.post("/api/login", login_data)
            .success(function(data) {
              if (!data.invalid_username) {
                if (!data.invalid_password) {
                  $scope.viewProfile(data.logged_in_as);
                  $scope.getPics(data.logged_in_as);
                  $scope.logged_in.username = data.logged_in_as;
                  $scope.selected_username = data.logged_in_as;
                  console.log("Logged in as " + $scope.logged_in.username);
                }
                else {
                  $("#password-error").show();
                  console.log("Invalid password.");
                }
              }
              else {
                $("#username-error").show();
                console.log("Invalid username.");
              }
            })
            .error(function(data) {
              console.log("Error: " + data);
            });
        };

        $scope.logout = function(username) {
          $http.get("/api/logout/")
          .success(function(data) {
            // Reset stuff!
            $scope.logged_in.username = data.logged_in_as;
            if ($(".home").is(':visible')) {
              $scope.getHome();
            }
            if ($(".profile").is(':visible')) {
              $scope.viewProfile($scope.selected_username);
            }
            if ($(".upload").is(':visible') || $(".update-prof").is(':visible')) {
              $(".upload").hide();
              $(".update-prof").hide();
              $(".home").show();
              $scope.getHome();
            }
          }).error(function(data) {
            console.log("Error: " + data);
          });
        };

        $scope.getPics = function(selected_username) {
          $http.get('/api/pictures/' + selected_username)
            .success(function(data) {
              if (!data.no_pics) {
                $scope.user_pics = data;
                var marker = [];
                for (var i=0; i < $scope.user_pics.length; i++) {
                  $scope.getCoords($scope.user_pics[i].location);
                  marker[i] = new google.maps.Marker({
                    map: $scope.user_map,
                    position: $scope.myLatLng
                  });
                }
              }
              else {
                console.log("No (public) pics from user.");
                $scope.user_pics = null;
              }
            })
            .error(function(data) {
              console.log('Error: ' + data);
            });
        };

        $scope.renderCreateProfile = function() {
          $scope.hideAllPgs();
          $(".create-prof").show();
          $("#edit-prof").hide();
          $("#submit-prof").show();
        };

        $scope.submitProfile = function(picFile) {
          console.log("create profile form submitted");
          var password1 = $("#new-password").val();
          var password2 = $("#re-password").val();
          if (password1 === password2) {
            $("#pass-mismatch").hide();
            var prof_data = {
              username: $("#new-username").val(),
              password: $("#new-password").val(),
              first_name: $("#first-name").val(),
              last_name: $("#last-name").val(),
              email: $("#email").val(),
              bio: $("#bio").val()
            };
            $http.post("/api/register", prof_data)
              .success(function(data) {
                if (data.username_taken) {
                  $("#username-taken").show();
                  console.log("Failed to register because username is taken. Usernames are case-insensitive.");
                }
                else if (data.email_taken) {
                  $("#email-taken").show();
                  console.log("Failed to register because email is already registered. Emails are case-insensitive.");
                }
                else {
                  if (picFile) {
                    $scope.uploadPic(picFile, data.logged_in_as, true);
                  }
                  else {
                    $scope.viewProfile(data.logged_in_as);
                  }
                  $scope.logged_in.username = data.logged_in_as;
                  console.log("Registered and created new profile for " + data.logged_in_as);
                }
              })
              .error(function(err) {
                console.log("Error: " + err);
              });
          }
          else {
            $("#pass-mismatch").show();
            console.log("Failed to register; passwords do not match.");
          }
        };

        $scope.showUnfreshProfile = function() {
          $(".page").hide();
          $(".profile").show();
          $("#picture img").show();
        };

        $scope.viewProfileWithPic = function(picture, location, address, private, likes, id, username) {
          $scope.viewProfile(username);
          $scope.displayPic(picture, location, address, private, likes, id, username);
        };

        $scope.viewProfile = function(username) {
          $scope.hideAllPgs();
          $(".profile").show();
          $scope.getMap();
          $scope.selected_username = username;
          $http.get('/api/profile/' + $scope.selected_username)
            .success(function(data) {
              if (data.prof_pic == null || data.prof_pic == '') {
                data.prof_pic = '/images/picllery.png';
                $("#profile-pic").css("background","#fff");
              }
              else {
                $("#profile-pic").css("background","#7554FF");
              }
              $scope.profile = {
                username: data.username,
                first_name: data.first_name,
                last_name: data.last_name,
                email: data.email,
                prof_pic: data.prof_pic,
                bio: data.bio
              };
            })
            .error(function(data) {
              console.log('Error: ' + data);
            });

          $scope.getPics($scope.selected_username);
        };

        $scope.getMap = function() {
          // Create profile map and set center
          var latlng = new google.maps.LatLng(1.0000, 1.0000);
          var mapOptions = {
            zoom: 1,
            center: latlng
          };
          $scope.user_map = new google.maps.Map(document.getElementById("map-canvas-user"), mapOptions);
        };

        $scope.getCoords = function(location) {
          var coords = location.split(",");
          var lat = coords[0].split(":");
          var lng1 = coords[1].split(":");
          var lng2 = lng1[1].split("}");
          $scope.myLatLng = new google.maps.LatLng(lat[1],lng2[0]);
        };

        $scope.setMarker = function(location, map) {
          $scope.getCoords(location);
          var marker = new google.maps.Marker({
            map: map,
            position: $scope.myLatLng
          });
          map.setCenter($scope.myLatLng);
          map.setZoom(10);
          // for mobile home:
          $(".section").css("z-index","0");
          $("#map-all").css("z-index","1");
        };

        $scope.showLikesAndLink = function(id) {
          $scope.thumb_clicked = id;
        };

        $scope.togglePicOptions = function() {
          var options = $("#edit-pic-button, #delete-pic-button, #likes, #toggle-hint, #expand");
          if (options.css("display") == "none") {
            options.css("display","inline-block");
          } else {
            options.css("display","none");
          }
        };

        $scope.expandPic = function(src) {
          $scope.src = src;
          $scope.expandedPic = $("#expanded-pic");
          $scope.expandedContainer = $(".expand-container");
          if ($scope.expandedPic.css("width") < $scope.expandedContainer.css("width")) {
            var left = ($scope.expandedContainer.css("width") - $scope.expandedPic.css("width")) / 2;
            $scope.expandedPic.css("left", left);
          }
        };

        $scope.closeExpand = function() {
          $scope.src = null;
        };

        $scope.displayPic = function(picture, location, address, priv, likes, id, username) {
          $("#picture img").show().attr("src", picture);
          $("#likes, #edit-pic-button, #delete-pic-button, #toggle-hint, #expand").css("display","inline-block");
          $("#count").html(likes);
          $scope.current_pic = {
            id: id,
            likes: likes,
            user: username,
            picture: picture
          };
          if (priv = 't') {
            priv = true;
          } else {
            priv = false;
          }
          $scope.current_pic.private = priv;
          $scope.setMarker(location, $scope.user_map);
          // TOO SPECIFIC RESULTS FOR IF USER ENTERED A VAGUE ADDRESS WHEN POSTING NEW PIC
          // $scope.getCoords(location);
          // $scope.geocoder.geocode({'latLng': $scope.myLatLng}, function(results, status) {
          //   if (status == google.maps.GeocoderStatus.OK) {
          //     if (results[0]) {
          //       $scope.reverse_geocode_location = results[0].formatted_address;
          //     } else {
          //       $scope.reverse_geocode_location = null;
          //     }
          //   } else {
          //     alert('Geocoder failed due to: ' + status);
          //   }
          // });
          // ALTERNATIVE: Return user's input-ed address as is.
          $scope.reverse_geocode_location = address;
        };

        $scope.addLikes = function(id, likes, username) { // Can only like once
          var data = {
            likes: likes
          };
          $http.put("/api/picture/" + id, data)
            .success(function(data) {
              $scope.getPics(username);
              $("#count").html(data.likes);
              console.log("Like added to pic with id " + id);
            })
            .error(function(data) {
              console.log("Error: " + data);
            });
        };

        $scope.renderEditPic = function() {
          $(".page").hide();
          $(".update-pic").show();
          $scope.isUpload = {upload: false};
          $scope.checkbox = {private: 'f'};
        };

        $scope.updatePic = function() {
          var address = $("#location").val();
          $scope.geocoder.geocode( {'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              var geolocation = results[0].geometry.location;
              var new_pic_data = {
                location: geolocation,
                address: address,
                private: $scope.checkbox.private,
                username: $scope.current_pic.user
              };
              console.log($scope.checkbox.private);
              $http.put("/api/picture/" + $scope.current_pic.id, new_pic_data)
                .success(function(data) {
                  if (data.not_logged_in || data.not_correct_user) {
                    console.log("Not logged in or authorised to edit picture.");
                  }
                  else {
                    console.log("Details updated for picture: " + $scope.current_pic.picture);
                    $scope.hideAllPgs();
                    $(".profile").show();
                    $scope.viewProfile(new_pic_data.username);
                  }
                })
                .error(function(data) {
                  console.log("Failed to update pic... :( Error: " + error);
                });
            } else {
              alert("Geocode was not successful for the following reason: " + status + ". Please try another address.");
            }
          });
        };

        $scope.deletePic = function() {
          $http.delete("/api/picture/" + $scope.current_pic.user + "/" + $scope.current_pic.id)
          .success(function(data) {
            if (data.not_logged_in || data.not_correct_user) {
              console.log("Not logged in or authorised to edit picture.");
            }
            else {
              console.log("Deleted pic with id: " + $scope.current_pic.id + " for user " + $scope.current_pic.user);
              $scope.hideAllPgs();
              $(".picture img").attr("src","");
              $(".profile").show();
              $scope.viewProfile($scope.current_pic.user);
              $scope.resetDelete();
            }
          })
          .error(function(data) {
            console.log("Error deleting pic: " + data);
          });
          // $scope.delete_clicked = false;
        };

        $scope.renderEditProfile = function() {
          $(".page").hide();
          $(".update-prof").show();
          $("#edit-prof").show();
          $("#submit-prof").hide();
          $("#new-username, #email").prop("disabled", true);
        };

        $scope.editProfile = function(picFile, username, logged_in) {
          console.log("update profile form submitted");
          var password1 = $("#new-password").val();
          var password2 = $("#re-password").val();
          if (password1 === password2) {
            $("#pass-mismatch").hide();
            if (logged_in) { // not creating new profile, upload pic happens here
              if (picFile) { // if new pic submitted, upload it
                $scope.uploadPic(picFile, username, false);
              }
              else { // if no new pic, no need for upload
                var filename = $scope.profile.prof_pic.split("picllery-user-images/");
                if (filename.length > 1) {
                  $scope.filename = filename[1]; // so that profile pic stays same if no change
                }
                else {
                  $scope.filename = null;
                }
                $scope.submitProfileEdit(username);
              }
            }
            else { // if creating new profile, upload pic happens beforehand
              $scope.submitProfileEdit(username);
            }
          }
          else {
            $("#pass-mismatch").show();
            console.log("Failed to register; passwords do not match.");
          }
        };

        $scope.submitProfileEdit = function(username) {
          var new_data = { // Can't change username or email
            password: $("#new-password").val(),
            first_name: $("#first-name").val(),
            last_name: $("#last-name").val(),
            prof_pic: "https://s3-us-west-2.amazonaws.com/picllery-user-images/" + $scope.filename,
            bio: $("#bio").val()
          };
          if (!$scope.filename) {
            new_data.prof_pic = "";
          }
          $http.put("/api/profile/" + username, new_data)
            .success(function(data) {
              if (data.not_logged_in) {
                console.log("Unauthorised to edit profile. Please log in.")
              }
              else if (data.err) {
                console.log(err);
              }
              else {
                $(".preview").attr("src",""); //reset
                $scope.progress = null;
                $scope.viewProfile(username);
                console.log("Updated profile for " + username);
              }
            })
            .error(function(data) {
              console.log("Error: " + err);
            });
        };

        $scope.deleteProfile = function(username) {
          $http.delete("/api/profile/" + username)
            .success(function(data) {
              if (data.not_logged_in) {
                console.log("Cannot delete profile; not logged in as user.");
              }
              else {
                console.log("Deleted profile for: " + username);
                $scope.logged_in.username = data.logged_in_as;
                $scope.renderHome();
                $scope.resetDelete();
              }
            })
            .error(function(data) {
              console.log("Error: " + err);
            });
        };

        $scope.renderUploadForm = function() {
          $scope.hideAllPgs();
          $(".upload").show();
          $scope.isUpload = {upload: true};
          $scope.progress = null;
          $scope.file = {picFile: null};
          $scope.checkbox = {private: 'f'};
        };

        $scope.file = {picFile: null};
        $scope.policy = "ewogICJleHBpcmF0aW9uIjogIjIwMjUtMDEtMDFUMDA6MDA6MDBaIiwKICAiY29uZGl0aW9ucyI6IFsKICAgIHsiYnVja2V0IjogInBpY2xsZXJ5LXVzZXItaW1hZ2VzIn0sCiAgICBbInN0YXJ0cy13aXRoIiwgIiRrZXkiLCAiIl0sCiAgICB7ImFjbCI6ICJwdWJsaWMtcmVhZCJ9LAogICAgWyJzdGFydHMtd2l0aCIsICIkQ29udGVudC1UeXBlIiwgIiJdLAogICAgWyJzdGFydHMtd2l0aCIsICIkZmlsZW5hbWUiLCAiIl0sCiAgICBbImNvbnRlbnQtbGVuZ3RoLXJhbmdlIiwgMCwgNTI0Mjg4MDAwXQogIF0KfQ==";
        $scope.signature = "G4CtuC9xOrWVumnNbMIUxkP5K0I=";

        $scope.uploadPic = function (files, username, submitFirstProfPic) {
          if (files && files.length) {
            for (var i = 0; i < files.length; i++) {
              var file = files[i];
              var identifier, filename;
              var d = new Date();
              var t = d.getTime();
              identifier = username + "/" + t;
              filename = identifier + "/" + file.name;
              $scope.upload = Upload.upload({
                  url: 'https://picllery-user-images.s3.amazonaws.com/',
                  method: 'POST',
                  fields : {
                    key: filename,
                    AWSAccessKeyId: "AKIAIOGEX3T2DE2FRA4Q",
                    acl: 'public-read',
                    policy: $scope.policy,
                    signature: $scope.signature,
                    "Content-Type": file.type != '' ? file.type : 'application/octet-stream',
                    filename: filename // this is needed for Flash polyfill IE8-9
                  },
                  file: file,
              }).progress(function (evt) {
                  var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);
                  $scope.progress = progressPercentage + '% ' + evt.config.file.name;
                  console.log('progress: ' + progressPercentage + '% ' + evt.config.file.name);
              }).success(function (data, status, headers, config) {
                  console.log('file ' + config.file.name + ' uploaded. Response: ' + data);
                  $scope.filename = filename;
                  $scope.progress = null;
                  $(".preview").attr("src",""); //reset
                  if (submitFirstProfPic == true) { // aka when creating new profile
                    $scope.editProfile('', username);
                    $scope.viewProfile(username);
                  }
                  else if (submitFirstProfPic == false) { // aka when editing prof pic
                    $scope.submitProfileEdit(username);
                  }
                  else {
                    $scope.postPic(filename, username);
                  }
              });
            }
          }
        };

        $scope.cancelUpload = function() {
          if ($scope.upload) {
            $scope.upload.abort(); // In case user was uploading, cancel that.
          };
          $scope.viewProfile($scope.logged_in.username);
        };

        $scope.geocoder = new google.maps.Geocoder();

        // Post new pic for existing user
        $scope.postPic = function(filename, username) {
          var address = $("#location").val();
          $scope.geocoder.geocode( {'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              var geolocation = results[0].geometry.location;
              var new_pic_data = {
                picture: "https://s3-us-west-2.amazonaws.com/picllery-user-images/" + filename,
                location: geolocation,
                address: address,
                private: $scope.checkbox.private
              };
              $http.post("/api/picture/" + username, new_pic_data)
                .success(function(data) {
                  console.log("Posted new pic for " + username);
                  $scope.hideAllPgs();
                  $(".profile").show();
                  $("input#file, input#location").val(''); // reset fields
                  $scope.viewProfile(username);
                })
                .error(function(data) {
                  console.log("Failed to post new pic... :( Error: " + error);
                });
            } else {
              alert("Geocode was not successful for the following reason: " + status + ". Please try another address.");
            }
          });
        };
      }]);
    </script>
  </body>
</html>