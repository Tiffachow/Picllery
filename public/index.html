<!DOCTYPE html>
<html ng-app="piclleryApp">
  <head>
    <title>Picllery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css' />
    <link href='http://fonts.googleapis.com/css?family=Poiret+One|Limelight|Abril+Fatface' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="/javascripts/main.js"></script>
  </head>
  <body>
    <div ng-controller="mainController">
      <header>
        <h1 id="title">Picllery</h1>
        <nav>
          <div id="not-logged-in" ng-if="username == null">
            <h1 class="link" id="login">Login</h1>
            <h1 class="link" id="create-prof">Create Profile</h1>
          </div>
          <div id="logged-in" ng-if="username !== null">
            <h2>Logged in as {{ username }}</h2>
            <h1 class="link" id="view-prof" ng-click="viewProfile(username)">View Profile</h1>
            <h1 class="link" id="upload">Upload Picture</h1>
          </div>
        </nav>
      </header>

      <!-- HOME PAGE -->
      <div class="container-fluid home page">
        <div class="row">
          <aside class="section col-xs-12 col-sm-12 col-md-1 col-lg-1 pull-right">
            <h2 id="user-title">USERS</h2>
            <nav class="users">
              <h1 class="user" ng-repeat="user in users.usernames" ng-click="viewProfile(user.username)">{{ user.username }}</h1>
            </nav>
          </aside>
          <div class="container-fluid">
            <div id="map-all" class="section purple col-xs-12 col-sm-12 col-md-5 col-md-offset-1 col-lg-5 col-lg-offset-1">
              <div class="inner-container">
                <div id="map-canvas"></div>
              </div>
            </div>
            <div id="recent-pop-pics" class="section purple col-xs-12 col-sm-12 col-md-5 col-md-offset-6 col-lg-5 col-lg-offset-6">
              <div class="inner-container">
                <div>
                  <span><h2>RECENT</h2></span>
                  <div>
                    <div ng-repeat="pic in users.recent" class="pic"><img src="{{ pic.picture }}"></div>
                    <div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div>
                  </div>
                </div>
                <div>
                  <span><h2>POPULAR</h2></span>
                  <div>
                    <div ng-repeat="pic in users.popular" class="pic"><img src="{{ pic.picture }}"></div>
                    <div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div><div class="pic"><img></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <nav class="mobile">
          <ul>
            <ul id="mobile-nav">
              <li id="recent-link">Recent</li>
              <li id="map-link">Map</li>
              <li id="users-link">Users</li>
            </ul>
            <li>NAV</li>
          </ul>
        </nav>
      </div>

      <!-- PROFILE PAGE -->
      <div class="container-fluid profile page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="profile">
              <div id="full-name"><h1>{{ profile.first_name }} {{ profile.last_name }}</h1></div>
              <div id="profile-pic"><img src="" alt="{{ profile.username }}'s profile pic"></div>
              <div class="details">
                <h2><span>Username:</span> {{ profile.username }}</h2>
                <h2><span>Email:</span> {{ profile.email }}</h2>
                <h2><span>Bio:</span> {{ profile.bio }}</h2>
              </div>
              <div class="prof-options" ng-if="username == profile.username">
                <p id="edit">Edit</p>
                <p id="delete" ng-click="deleteProfile(username)">Delete</p>
              </div>
            </div>
            <div class="gallery col-xs-12 col-sm-12 col-md-12 col-lg-12 row">
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4" >
                <div id="gallery"> <!-- GALLERY -->
                  <div class="pic"><a href="#picture"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></a></div><div class="pic"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></div><div class="pic"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></div><div class="pic"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></div><div class="pic"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></div><div class="pic"><img ng-click="displayPic()" src="http://www.wallulung.com/wp-content/uploads/2015/04/baby_rabbit_894_cute_animal.jpg"></div>
                  <img ng-click="displayPic()" ng-repeat="pic in user_pics" src="{{ pic.picture }}" class="pic">
                  <img ng-click="displayPic()" ng-repeat="pic in user_pics" src="{{ pic.picture }}" class="pic">
                </div>
              </div>
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                <div id="picture"><img></div> <!-- PICTURE -->
              </div>
              <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                <div id="map"></div> <!-- MAP -->
              </div>
            </div>
          </div>
          <nav class="profile-mobile">
            <a href="#gallery">Gallery</a>
            <a href="#picture">Picture</a>
            <a href="#map">Location</a>
          </nav>
        </div>
      </div>

      <!-- LOGIN PAGE -->
      <div class="container-fluid login page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <form id="login-form">
              <div class="form-group">
                <h2 class="error" id="username-error">INVALID USERNAME. Please try again.</h1>
                <label for="username">Username:</label><input class="form-control" id="username" name="username" type="text" autocomplete required><br>
                <h2 class="error" id="password-error">INVALID PASSWORD. Please try again.</h1>
                <label for="password">Password:</label><input class="form-control" id="password" name="password" type="password" autocomplete required><br>
                <button type="submit" ng-click="submitLogin()">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div> 

      <!-- CREATE PROFILE PAGE -->
      <div class="container-fluid create-prof update-prof page">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
            <form id="create-prof-form">
              <div class="form-group">
                <h2 class="error" id="username-taken">Username is taken, please try again!</h2>
                <label for="username">Username:</label><input class="form-control" value="{{ profile.username }}" id="new-username" name="username" type="text" placeholder="Enter Username" autocomplete required><br>
                <label for="password">Password:</label><input class="form-control" id="new-password" name="password" type="password" placeholder="Enter New Password" autocomplete required><br>
                <h2 class="error" id="pass-mismatch">Passwords do not match, please try again!</h2>
                <label for="re-password">Password, Again:</label><input class="form-control" id="re-password" name="re-password" type="password" placeholder="Re-enter Password" autocomplete required><br>
                <div class="form-inline">
                  <label for="first-name">First Name:</label><input class="form-control" value="{{ profile.first_name }}" id="first-name" name="first-name" type="text" autocomplete required>
                  <label for="last-name">Last Name:</label><input class="form-control" value="{{ profile.last_name }}" id="last-name" name="last-name" type="text" autocomplete required>
                </div>
                <label for="email">Email:</label><input class="form-control" value="{{ profile.email }}" id="email" name="email" type="email" placeholder="e.g. hello_there@gmail.com" autocomplete required><br>
                <label for="prof-pic">Profile Picture:</label><input name="prof-pic" value="{{ profile.prof_pic }}" id="prof-pic" class="form-control" type="file" accept="image/*"><br>
                <label for="bio">Bio:</label><textarea class="form-control" value="{{ profile.bio }}" id="bio" name="bio" rows="4" placeholder="Tell us a little about yourself..."></textarea><br>
                <button id="submit-prof" type="submit" ng-click="submitProfile()">Submit</button>
                <button id="edit-prof" type="submit" ng-click="editProfile()">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- UPLOAD PICTURE PAGE -->
    <div class="container-fluid upload page">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 center-container">
          <form id="upload-form">
            <div class="form-group">
              <label for="picture">Picture:</label><input name="picture" id="picture" class="form-control" type="file" accept="image/*" required><br>
              <label for="location">Location (address):</label><input class="form-control" id="location" name="location" type="text" required><br>
              <div class="form-inline">
                <label>Private? <input class="form-control" id="private" name="private" type="checkbox" value="private"></label><br>
              </div>
              <button type="submit" value="encode">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div> 

    <div id="footer">
      <p><small>Copyright &#169; 2015 Picllery. All rights reserved.</small></p>
    </div>
    <script>
      var piclleryApp = angular.module("piclleryApp", [])
      .controller("mainController", ['$scope', '$http', function($scope, $http) {
        // when landing on the page, get all usernames and show them
        $http.get('/api/home')
          .success(function(data) {
            $scope.users = {
              usernames: data.usernames,
              recent: data.recent,
              popular: data.popular
            };
            var marker = {
              recent: [],
              popular: []
            };
            for (var i=0; i < ($scope.users.recent.length - 1); i++) {
              marker.recent[i] = new google.maps.Marker({
                map: map,
                position: $scope.users.recent[i].location
              });
            }
            for (var i=0; i < ($scope.users.popular.length - 1); i++) {
              marker.popular[i] = new google.maps.Marker({
                map: map,
                position: $scope.users.popular[i].location
              });
            }
            $scope.username = data.logged_in_as;
            console.log(data);
          })
          .error(function(data) {
            console.log('Error: ' + data);
          });

        $scope.submitLogin = function() {
          var login_data = {
            username: $("#username").val(),
            password: $("#password").val()
          };
          $http.post("/api/login", login_data)
            .success(function(data) {
              if (!data.invalid_username) {
                if (!data.invalid_password) {
                  hideAllPgs();
                  $(".profile").show();
                  $scope.profile = {
                    username: data.username,
                    first_name: data.first_name,
                    last_name: data.last_name,
                    email: data.email,
                    prof_pic: data.prof_pic,
                    bio: data.bio
                  };
                }
                else {
                  $("#password-error").show();
                  console.log("Invalid password.");
                }
              }
              else {
                $("#username-error").show();
                console.log("Invalid username.");
              }
            })
            .error(function(data) {
              console.log("Error: " + data);
            });
        };

        $scope.submitProfile = function() {
          console.log("create profile form submitted");
          var password1 = $("#new-password").val();
          var password2 = $("#re-password").val();
          if (password1 === password2) {
            $("#pass-mismatch").hide();
            var prof_data = {
              username: $("#new-username").val(),
              password: $("#new-password").val(),
              first_name: $("#first-name").val(),
              last_name: $("#last-name").val(),
              email: $("#email").val(),
              prof_pic: $("#prof-pic").val(),
              bio: $("#bio").val()
            };
            $http.post("/api/register", prof_data)
              .success(function(data) {
                if (data.username_taken) {
                  $("#username-taken").show();
                  console.log("Failed to register because username is taken.");
                }
                else {
                  hideAllPgs();
                  $(".profile").show();
                  $scope.profile = {
                    username: data.username,
                    first_name: data.first_name,
                    last_name: data.last_name,
                    email: data.email,
                    prof_pic: data.prof_pic,
                    bio: data.bio
                  };
                  console.log("Registered and created new profile for: " + data.username);
                }
              })
              .error(function(err) {
                console.log("Error: " + err);
              });
          }
          else {
            $("#pass-mismatch").show();
            console.log("Failed to register; passwords do not match.");
          }
        };

        $scope.viewProfile = function(username) {
          $(".page").hide();
          $(".profile").show();
          var selected_username = String(username);
          $http.get('/api/profile/' + selected_username)
            .success(function(data) {
              $scope.profile = {
                username: data.username,
                first_name: data.first_name,
                last_name: data.last_name,
                email: data.email,
                prof_pic: data.prof_pic,
                bio: data.bio
              };
            })
            .error(function(data) {
              console.log('Error: ' + data);
            });

          $http.get('/api/pictures/' + selected_username)
            .success(function(data) {
              if (!data.no_pics) {
                $scope.user_pics = data;
              }
              else {
                console.log("No public pics from user.");
              }
            })
            .error(function(data) {
              console.log('Error: ' + data);
            });
        };

        $scope.editProfile = function(username) {
          console.log("update profile form submitted");
          var password1 = $("#new-password").val();
          var password2 = $("#re-password").val();
          if (password1 === password2) {
            $("#pass-mismatch").hide();
            var new_data = {
              username: $("#new-username").val(),
              password: $("#new-password").val(),
              first_name: $("#first-name").val(),
              last_name: $("#last-name").val(),
              email: $("#email").val(),
              prof_pic: $("#prof-pic").val(),
              bio: $("#bio").val()
            };
            $http.put("/api/profile/" + username, new_data)
              .success(function(data) {
                if (data.username_taken) {
                  $("#username-taken").show();
                  console.log("Failed to update because username is taken.");
                }
                else {
                  hideAllPgs();
                  $(".profile").show();
                  $scope.profile = {
                    username: data.username,
                    first_name: data.first_name,
                    last_name: data.last_name,
                    email: data.email,
                    prof_pic: data.prof_pic,
                    bio: data.bio
                  };
                  console.log("Updated profile for: " + data.username);
                }
              })
              .error(function(data) {
                console.log("Error: " + err);
              });
          }
          else {
            $("#pass-mismatch").show();
            console.log("Failed to register; passwords do not match.");
          }
        };

        $scope.deleteProfile = function(username) {
          $http.delete("/api/profile/" + username)
            .success(function(data) {
              if (not_logged_in) {
                console.log("Cannot delete profile; not logged in as user.");
              }
              else {
                console.log("Deleted profile for: " + username);
              }
            })
            .error(function(data) {
              console.log("Error: " + err);
            });
        };

        $scope.displayPic = function() {
          console.log($(this));
          var img = $(this).attr("src");
          $("#picture img").show().attr("src",img);
        };
      }]);
    </script>
  </body>
</html>